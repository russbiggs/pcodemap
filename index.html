<!DOCTYPE html>
<html>
<meta charset="utf-8">
<head>
	<style>

	h1 {
		font-weight:normal;
		font-size:3em;
		margin:0;

	}

	h2 {
		font-weight:normal;
		font-size:2em;
		margin:0;

	}
	.syr_admin3-boundary {
	  fill: none;
	  stroke: #FFF;
	  stroke-linejoin: round;
	}
	  
	.syr_admin3 { 
	  fill: #CDCDCD; 
	}

	.syr_admin3:hover { 
	  fill: #CD435B; 
	}


	.gov-label {
	  pointer-events: none;
	  fill: #525252;
	  font-size: 10px;
	  font-weight: 300;
	  text-anchor: middle;
	  text-shadow: 0.5px 0.5px 0.5px #fff;
	}

	.gov_bounds {
		fill:none;
		stroke:#525252; 
	}

	html {
	  font-family: "Helvetica Neue", Helvetica, sans-serif;
	  font-size: 10px;	  
	}
		
	text {
		pointer-events: none;	
	}
	
	#container {
		width:1252px;
		height:502px;
		margin: 0 auto;	
	}

	#header {
		margin-top:20px;
		width:1250px;
		height:75px;
		margin: 0 auto;
	}

	#area1 {
		<!--background-color:red;-->
		width:49%;
		height: 99%;
		float:left;
		margin-left:0;
		margin-right:0;
		border-width:0.5%;
		border-color:black;
		border-style:solid;
		
	}

	#area2 {
		<!--background-color:blue;-->
		width:100%;
		height: 60%;
		margin-left:0;
		margin-right:0;
	}

	#area3 {
		<!--background-color:green;-->
		width:100%;
		height: 35%;
		margin-left:0;
		margin-right:0;
		clear:both;
	}

	#footer {
		width:100%;
		height: 30px;
		clear:both;
		float:bottom;
		margin-bottom: 0
	}

	table {
		width:70%;
		font-size:2em;
	}
	
	td:first-child + td + td {
		text-align:right;
	}

	td:first-child{
		font-weight:bold;
	}

	.selected {
		fill:red;
		transition.5s;
	}

	.selected:hover {
		fill:green;
	}
	
	#frame {
		width:49%;
		height:99%;
		float:left;
		margin-left:0;
		margin-right:0;
		border-width:0.5%;
		border-color:black;
		border-style:solid;
	}
	
	#button {
		background-color:grey;
		text-align:center;
		height:4%;
		width:50%;
		float:left;
		margin-left:0;
		margin-right:0;
		line-height:28px;
		border-radius:5px;
		clear:left;
		paddingTop:0.5%;
		paddingBottom:0.5%;
		
	}
	.button {
		background-color:grey;
		text-align:center;
		height:4%;
		width:100%;
	
	}
	#selectButton {
		background-color:grey;
		text-align:center;
		height:4%;
		width:50%;
		float:left;
		margin-left:0;
		margin-right:0;
		line-height:28px;
		border-radius:5px;
		clear:left;
		
	}
	
	span {
		vertical-align: middle;
		font-size:1.2em;
		color:white;
		pointer-events:none;
	
	}
	
	#download, #selector {
		display: inline-block;
		width:50%;
	}

	</style>
</head>
<body>
<script src="/js/d3.min.js"></script>
<script src="/js/topojson.v1.min.js"></script>
<script src="PapaParse-4.1.0/papaparse.min.js" type="text/javascript"></script>

<div id="header">
	<h1>Syrian Arab Republic Reference Map</h1>
	<h2>Sub-district Identifier </h2>
</div>
<div id="container">


<div id="area1"></div>
<div id="frame">
<div id="area2"></div>
<div id="area3"></div>
<a id="download">
<div id="button">
<span>Download .csv</span>
</div>
</a>
<a id="selector">
<div id="selectButton">
<span id="selectorSpan">Select all</span>
</div>
</a>
</div>
<div id="footer"><p>Data: Modified from <a href="http://www.humanitarianresponse.info/en/applications/data/datasets/locations/syrian-arab-republic">Common Operational Dataset(COD)<a> </p></div>
</div>

<script>
var width = 625;
    height = 500,
	height2 = 300,
	active = d3.select(null);

var projection = d3.geo.mercator()
    .center([39,35])
    .scale(4400)
    .translate([width / 2, height / 2.1]);

var path = d3.geo.path()
    .projection(projection);

var zoom = d3.behavior.zoom()
	.scaleExtent([1,3])
	.on("zoom", zoomed);

var map1 = d3.select("#area1").append("svg")
    .attr("width", width)
    .attr("height", height)
	.call(zoom)
	.append("g");
	
d3.select("#selectButton")
	.on('click',selectDeselect);
	
d3.json("syria_adm.json", function(error, Syria) {
	var subdists = topojson.feature(Syria, Syria.objects.syr_admin3),
		govs = topojson.feature(Syria, Syria.objects.syr_admin1_gov);
	map1.selectAll(".syr_admin3")
      .data(subdists.features)
    .enter().append("path")
      .attr("class", function(d) { return ( "syr_admin3 "); })
	  .attr("id", function(d) { return (d.properties.PCODE);})
      .attr("d", path)
	  .on("mouseover",hover)
	  .on("mouseout", reset)
	  .on("click",clicked); 
	  
	map1.append("path")
	  .datum(topojson.mesh(Syria, Syria.objects.syr_admin3, function(a, b) { return a !== b  ; }))
	  .attr("d", path)
	  .attr("class", "syr_admin3-boundary");
	  
	map1.append("path")
	  .datum(topojson.mesh(Syria, Syria.objects.syr_admin1_gov, function(a, b) { return a !== b  ; }))
	  .attr("d", path)
	  .attr("class", "gov_bounds");
	  
	map1.selectAll("text")
	  .data((topojson.feature(Syria, Syria.objects.syr_admin1_gov).features))
	  .enter()
	  .append("text")
	  .text(function(d) {return d.properties.ADMIN1_EN})
	  .attr("x", function(d){
	    	return path.centroid(d)[0];
	  })
	  .attr("y", function(d){
	    	return  path.centroid(d)[1];
	  })
	 .attr("class","gov-label");	  
});
	
var map2 = d3.select("#area2").append("svg")
			 .attr("width", width)
			 .attr("height", height);
	
var g2 = map2.append("g");
	

d3.json("syria_adm.json", function(error, Syria) {
	var subdists = topojson.feature(Syria, Syria.objects.syr_admin3),
		comms = topojson.feature(Syria, Syria.objects.syr_admin4_cap);

	g2.selectAll(".syr_admin3_2")
      .data(subdists.features)
    .enter().append("path")
      .attr("class", function(d) { return ( "syr_admin3_2 "); })
	  .attr("id", function(d) { return (d.properties.PCODE + "_2");})
	  .style("opacity",0)
      .attr("d", path);	
	  
	  
	g2.selectAll("comms")
      .data(comms.features)
	  .enter().append("path")
      .attr("class", "comms")
	  .attr("id", function(d) {return (d.properties.ADMIN3_COD + "_comm");})
	  .style("opacity",0);
	  
	g2.selectAll("comm-labels")
      .data(comms.features)
	  .enter().append("text")
      .attr("class", "comm-labels")
	  .attr("id", function(d) {return (d.properties.ADMIN3_COD + "_comm");})
	  .text(function (d) {return (d.properties.NAME_EN);})
	  .style("opacity",0)
      .attr("transform", function(d) { return "translate(" + path.centroid(d) + ")"; });
      

});

var table = d3.select("#area3");

function zoomed() {
	map1.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
	map1.select(".syr_admin3-boundary").style("stroke-width",1 /d3.event.scale + "px");
}

function hover(d) {
	var bounds = path.bounds(d),
		dx = bounds[1][0] - bounds[0][0],
		dy = bounds[1][1] - bounds[0][1],
		x = (bounds[0][0] + bounds[1][0]) / 2,
		y = (bounds[0][1] + bounds[1][1]) / 2,
		scale = .9 / Math.max(dx / width, dy / height2),
		translate = [width / 2 - scale * x, height2 / 2 - scale * y];
		
	d3.select("#" + this.id + "_2") 
		.style("fill","#CDCDCD")	
		.style("opacity",1);
		
	d3.selectAll("#" + this.id + "_comm")
		.style("opacity",1)
		.attr("d", path.pointRadius(2/scale));
		
	d3.selectAll("text#" + this.id + "_comm")
	  .style("opacity",1)
	  .style("font-size", 12/scale + "px")
	  .attr("dx", 2/scale + "em")
	  .attr("dy", 2/scale + "em");
		
	if (active.node() === this) return reset();
	active.classed("active", false);
	active = d3.select(this).classed("active", true);
	
	g2.transition()
      .duration(0)
      .attr("transform", "translate(" + translate + ")scale(" + scale + ")");
	  
	table.html("<table align='center';><th colspan='3'>" + d.properties.PCODE + "</th><tr><td>Sub-district</td><td>" + d.properties.NAME_EN + "</td><td>" + d.properties.NAME_ARA + "</td></tr><tr><td>District</td><td>" +  d.properties.ADMIN2_EN + "</td><td>" + d.properties.ADMIN2_ARA + "</td></tr><tr><td>Governorate</td><td>" + d.properties.ADMIN1_EN  + "</td><td>" +  d.properties.ADMIN1_ARA + "</td></tr></table>");
}

function reset() {
	d3.select("#" + this.id + "_2") 
	  .style("opacity",0);
	
	d3.selectAll("#" + this.id + "_comm")
	  .style("opacity",0)
	  .attr("d",path.pointRadius(0));
	  
	d3.selectAll("text#" + this.id + "_comm")
	  .style("opacity",0)
	
	active.classed("active", false);
	active = d3.select(null);

	g2.transition()
      .duration(0)
      .attr("transform", "");
	  
	table.html("");
}

function buttonLabel(arr) {
	var spanSelect = d3.select("#selectorSpan");
	if (arr.objects.length === 0) {
		spanSelect.text("Select all");		
	}else{
		spanSelect.text("Clear current selection");
	}
}

var pcodeList = {};
pcodeList.objects = [];
function clicked(d) {
	
	if (this.className.baseVal === "syr_admin3 active"){
		console.log
		var selection = d3.select("#" + d.properties.PCODE)
		.attr("class","selected");
		pcodeList.objects.push(
			{"pcode": d.properties.PCODE, 
			 "name_en": d.properties.NAME_EN,
			 "name_ar": d.properties.NAME_ARA,
			 "dist_en":d.properties.ADMIN2_EN,
			 "dist_ar":d.properties.ADMIN2_ARA,
			 "gov_en":d.properties.ADMIN1_EN,
			 "gov_ar":d.properties.ADMIN1_ARA}
			);
	}else {	
		var index = pcodeList.objects.map(function(e) { return e.pcode; }).indexOf(d.properties.PCODE);
		pcodeList.objects.splice( index, 1 );				
		d3.select("#" + d.properties.PCODE)
		  .attr("class","syr_admin3 ");
	}
	buttonLabel(pcodeList);
	var csv = Papa.unparse(pcodeList.objects),
		BOM = "\uFEFF",
		csvBom = BOM + csv,
		date = new Date(),
		time = '_' +('0' +date.getHours()).slice(-2) + ('0' +date.getMinutes()).slice(-2);
		fileName = "pcodelist" + time + ".csv";
	d3.select("#download")
	  .attr("download",fileName)
	  .attr("href",'data:text/csv;charset=utf-8,'+encodeURIComponent(csvBom));	  
};

function selectDeselect(d) {
	if (pcodeList.objects.length > 0) {
		pcodeList.objects = [];
		d3.selectAll(".selected")
		.attr("class", "syr_admin3 ");
	}else{	
		var selectThings = d3.selectAll(".syr_admin3 ")
		.attr("class","selected");
		selectThings.each(function(d,i) {	pcodeList.objects.push(
		{"pcode": d.properties.PCODE, 
		"name_en": d.properties.NAME_EN,
		"name_ar": d.properties.NAME_ARA,
		"dist_en":d.properties.ADMIN2_EN,
		"dist_ar":d.properties.ADMIN2_ARA,
		"gov_en":d.properties.ADMIN1_EN,
		"gov_ar":d.properties.ADMIN1_ARA}
		);});

		};
		
	//this needs to be incorporated into a function since it is used twice
	var csv = Papa.unparse(pcodeList.objects),
		BOM = "\uFEFF",
		csvBom = BOM + csv,
		date = new Date(),
		time = '_' +('0' +date.getHours()).slice(-2) + ('0' +date.getMinutes()).slice(-2);
		fileName = "pcodelist" + time + ".csv";
	d3.select("#download")
	  .attr("download",fileName)
	  .attr("href",'data:text/csv;charset=utf-8,'+encodeURIComponent(csvBom));
		
	buttonLabel(pcodeList);
}


</script>

</body>
</html>